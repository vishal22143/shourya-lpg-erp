{% extends "base.html" %}
{% block title %}Owner Dashboard{% endblock %}

{% block nav_tabs %}
<div class="tab-bar">
  <a href="/owner/dashboard" class="active">ğŸ‘‘ Owner</a>
  <a href="/office/dashboard">ğŸ¢ Office</a>
  <a href="/delivery/dashboard">ğŸšš Delivery</a>
  <a href="/owner/dayend">ğŸ“Š Day End</a>
  <a href="/owner/users">ğŸ‘¥ Users</a>
  <a href="/owner/vehicles">ğŸš— Vehicles</a>
</div>
{% endblock %}

{% block content %}
<div class="page-title">ğŸ‘‘ Owner Dashboard</div>
<div class="page-sub">{{ today.strftime('%d %B %Y') }} Â· Shourya Bharatgas Services</div>

{% if erp_day %}
<div class="alert {% if erp_day.status.value == 'OPEN' %}alert-success{% else %}alert-error{% endif %}">
  Day Status: <strong>{{ erp_day.status.value }}</strong>
  {% if erp_day.status.value == 'OPEN' %}
  Â· Opened at {{ erp_day.opened_at.strftime('%I:%M %p') if erp_day.opened_at }}
  {% endif %}
</div>
{% else %}
<div class="alert alert-info">âš ï¸ ERP day not yet opened. First login will open it.</div>
{% endif %}

<!-- MASTER STATS -->
<div class="stat-grid">
  <div class="stat-box green">
    <div class="val">{{ total_delivered }}</div>
    <div class="lbl">Total Delivered / à¤à¤•à¥‚à¤£ à¤•à¥‡à¤²à¥‡</div>
  </div>
  <div class="stat-box green">
    <div class="val">â‚¹{{ total_cash|int }}</div>
    <div class="lbl">Total Cash / à¤à¤•à¥‚à¤£ à¤°à¥‹à¤–</div>
  </div>
  <div class="stat-box blue" style="--primary:#1a56db;">
    <div class="val">â‚¹{{ total_online|int }}</div>
    <div class="lbl">Online / à¤‘à¤¨à¤²à¤¾à¤ˆà¤¨</div>
  </div>
  <div class="stat-box">
    <div class="val">{{ trips|length }}</div>
    <div class="lbl">Trips Today</div>
  </div>
</div>

<!-- TRIP SUMMARY TABLE -->
{% if trips %}
<div class="card">
  <div class="card-title">ğŸšš Trip-wise Summary / à¤Ÿà¥à¤°à¤¿à¤ª à¤¸à¤¾à¤°à¤¾à¤‚à¤¶</div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Trip</th>
          <th>Staff</th>
          <th>Vehicle</th>
          <th>Issued</th>
          <th>Sold</th>
          <th>Cash â‚¹</th>
          <th>Online â‚¹</th>
          <th>BDA Cash â‚¹</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for t in trips %}
        <tr>
          <td><strong>#{{ t.id }}</strong></td>
          <td>{{ t.delivery_man.name }}</td>
          <td>{{ t.vehicle.name }}</td>
          <td>{{ t.filled_issued }}</td>
          <td><strong>{{ t.total_sales }}</strong></td>
          <td style="color:#057a55;">â‚¹{{ t.cash_collected|int }}</td>
          <td style="color:#1a56db;">â‚¹{{ t.online_collected|int }}</td>
          <td style="color:#c27803;">â‚¹{{ t.bda_cash|int }}</td>
          <td>
            {% if t.status.value == 'OPEN' %}
            <span class="badge badge-green">OPEN</span>
            {% else %}
            <span class="badge badge-gray">CLOSED</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- WAGES TODAY -->
{% if wages %}
<div class="card">
  <div class="card-title">ğŸ’° Wages Today / à¤†à¤œà¤šà¥‡ à¤µà¥‡à¤¤à¤¨</div>
  <div class="table-wrap">
    <table>
      <tr><th>Staff</th><th>Urban Cyl</th><th>Rural Cyl</th><th>Gross â‚¹</th><th>Recovery â‚¹</th><th>Net â‚¹</th></tr>
      {% for w in wages %}
      <tr>
        <td>{{ w.staff.name }}</td>
        <td>{{ w.cylinders_urban }}</td>
        <td>{{ w.cylinders_rural }}</td>
        <td>â‚¹{{ w.gross_wage|round(2) }}</td>
        <td style="color:#e02424;">â‚¹{{ w.advance_recovery|round(2) }}</td>
        <td style="color:#057a55;font-weight:700;">â‚¹{{ w.net_wage|round(2) }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
{% endif %}

<!-- DAY END ACTION -->
<div class="card">
  <div class="card-title">ğŸ“Š Day End / à¤¦à¤¿à¤µà¤¸ à¤¸à¤‚à¤ªà¤µà¤¾</div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <form method="post" action="/owner/generate-dayend">
      <button type="submit" class="btn btn-primary">ğŸ“Š Generate Day End Report</button>
    </form>
    {% if erp_day and erp_day.status.value == 'OPEN' %}
    <form method="post" action="/owner/lock-day" onsubmit="return confirm('Lock today? This cannot be undone.')">
      <button type="submit" class="btn btn-danger">ğŸ”’ Lock Day / à¤¦à¤¿à¤µà¤¸ à¤²à¥‰à¤• à¤•à¤°à¤¾</button>
    </form>
    {% endif %}
  </div>
</div>

{% endblock %}
