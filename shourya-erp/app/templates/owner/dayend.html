{% extends "base.html" %}
{% block title %}Day End Report{% endblock %}

{% block nav_tabs %}
<div class="tab-bar">
  <a href="/owner/dashboard">‚Üê Owner</a>
  <a href="/owner/dayend" class="active">üìä Day End</a>
</div>
{% endblock %}

{% block content %}
<div class="page-title">üìä Day End Report</div>
<div class="page-sub">{{ today.strftime('%d %B %Y') }}
  {% if erp_day %} ¬∑ <span class="badge {% if erp_day.status.value == 'LOCKED' %}badge-red{% else %}badge-green{% endif %}">{{ erp_day.status.value }}</span>{% endif %}
</div>

{% if not snapshot %}
<div class="alert alert-info">
  üìä No day end report generated yet.
  <form method="post" action="/owner/generate-dayend" style="display:inline;margin-left:10px;">
    <button type="submit" class="btn btn-sm btn-primary">Generate Now</button>
  </form>
</div>
{% else %}

{% set s = snapshot.snapshot_json %}

<!-- DELIVERY SUMMARY -->
<div class="card">
  <div class="card-title">üöö Delivery Summary / ‡§°‡§ø‡§≤‡§ø‡§µ‡•ç‡§π‡§∞‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</div>
  <div class="stat-grid" style="margin-bottom:0;">
    <div class="stat-box green">
      <div class="val">{{ s.delivery_summary.delivered }}</div>
      <div class="lbl">Delivered / ‡§ù‡§æ‡§≤‡•á</div>
    </div>
    <div class="stat-box amber">
      <div class="val">{{ s.delivery_summary.pending }}</div>
      <div class="lbl">Pending / ‡§¨‡§æ‡§ï‡•Ä</div>
    </div>
    <div class="stat-box red">
      <div class="val">{{ s.delivery_summary.cancelled }}</div>
      <div class="lbl">Cancelled / ‡§∞‡§¶‡•ç‡§¶</div>
    </div>
    <div class="stat-box">
      <div class="val">{{ s.delivery_summary.scheduled }}</div>
      <div class="lbl">Total Scheduled</div>
    </div>
  </div>
</div>

<!-- CASH SUMMARY -->
<div class="card">
  <div class="card-title">üíµ Cash Summary / ‡§∞‡•ã‡§ñ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</div>
  <div class="stat-grid" style="margin-bottom:0;">
    <div class="stat-box green">
      <div class="val">‚Çπ{{ s.cash_summary.total_in|int }}</div>
      <div class="lbl">Cash IN / ‡§Ü‡§≤‡•á</div>
    </div>
    <div class="stat-box red">
      <div class="val">‚Çπ{{ (s.cash_summary.total_out|abs)|int }}</div>
      <div class="lbl">Cash OUT / ‡§ó‡•á‡§≤‡•á</div>
    </div>
    <div class="stat-box">
      <div class="val">‚Çπ{{ s.cash_summary.net|int }}</div>
      <div class="lbl">Net / ‡§®‡§ø‡§µ‡•ç‡§µ‡§≥</div>
    </div>
  </div>
</div>

<!-- STOCK SUMMARY -->
<div class="card">
  <div class="card-title">üì¶ Stock Summary / ‡§∏‡§æ‡§†‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</div>
  {% if s.stock_summary.godown_ledger %}
  <div class="table-wrap">
    <table>
      <tr><th>Product</th><th>Filled / ‡§≠‡§∞‡§≤‡•á‡§≤‡•á</th><th>Empty / ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•á</th></tr>
      {% for code, vals in s.stock_summary.godown_ledger.items() %}
      <tr>
        <td><strong>{{ code }}</strong></td>
        <td style="color:#057a55;">{{ vals.filled }}</td>
        <td style="color:#c27803;">{{ vals.empty }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}
  {% if s.stock_summary.physical_count %}
  <div class="alert alert-info" style="margin-top:10px;">
    Physical Count: 14.2kg Filled = <strong>{{ s.stock_summary.physical_count.filled_14_2 }}</strong>,
    Empty = <strong>{{ s.stock_summary.physical_count.empty_14_2 }}</strong>
    {% set ledger_filled = s.stock_summary.godown_ledger.get('5350', {}).get('filled', 0) %}
    {% if s.stock_summary.physical_count.filled_14_2 != ledger_filled %}
    <br><span style="color:#e02424;">‚ö†Ô∏è Difference: {{ s.stock_summary.physical_count.filled_14_2 - ledger_filled }}</span>
    {% else %}
    <span style="color:#057a55;"> ‚úÖ Match!</span>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- TRIP-WISE -->
<div class="card">
  <div class="card-title">üöö Trip-wise Breakup / ‡§ü‡•ç‡§∞‡§ø‡§™ ‡§§‡§™‡§∂‡•Ä‡§≤</div>
  <div class="table-wrap">
    <table>
      <tr><th>Trip</th><th>Delivery Man</th><th>Vehicle</th><th>Sold</th><th>Cash ‚Çπ</th><th>Online ‚Çπ</th><th>BDA ‚Çπ</th></tr>
      {% for t in s.trip_summaries %}
      <tr>
        <td>#{{ t.trip_id }}</td>
        <td>{{ t.delivery_man }}</td>
        <td>{{ t.vehicle }}</td>
        <td><strong>{{ t.total_sales }}</strong></td>
        <td>‚Çπ{{ t.cash_collected|int }}</td>
        <td>‚Çπ{{ t.online_collected|int }}</td>
        <td>‚Çπ{{ t.bda_cash|int }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>

<!-- BDA -->
<div class="card">
  <div class="card-title">üèòÔ∏è BDA Summary</div>
  <div class="stat-grid" style="margin-bottom:0;">
    <div class="stat-box">
      <div class="val">{{ s.bda_summary.filled_issued }}</div>
      <div class="lbl">Filled Issued / ‡§¶‡§ø‡§≤‡•á</div>
    </div>
    <div class="stat-box green">
      <div class="val">‚Çπ{{ s.bda_summary.cash_collected|int }}</div>
      <div class="lbl">BDA Cash</div>
    </div>
    <div class="stat-box">
      <div class="val">‚Çπ{{ s.bda_summary.online_collected|int }}</div>
      <div class="lbl">BDA Online</div>
    </div>
  </div>
</div>

<!-- WAGES -->
<div class="card">
  <div class="card-title">üí∞ Total Wages / ‡§è‡§ï‡•Ç‡§£ ‡§µ‡•á‡§§‡§®</div>
  <div style="font-size:1.5rem;font-weight:800;color:#1a56db;">‚Çπ{{ s.wages_total|round(2) }}</div>
</div>

<!-- LOCK ACTION -->
{% if erp_day and erp_day.status.value == 'OPEN' %}
<div class="card" style="border:2px solid #e02424;">
  <div class="card-title" style="color:#e02424;">üîí Lock Day / ‡§¶‡§ø‡§µ‡§∏ ‡§≤‡•â‡§ï ‡§ï‡§∞‡§æ</div>
  <p style="font-size:0.85rem;color:#6b7280;margin-bottom:14px;">
    Once locked, no changes can be made to today's data. / ‡§è‡§ï‡§¶‡§æ ‡§≤‡•â‡§ï ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§¨‡§¶‡§≤ ‡§π‡•ã‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä.
  </p>
  <form method="post" action="/owner/lock-day" onsubmit="return confirm('Confirm lock day? This cannot be undone.')">
    <button type="submit" class="btn btn-danger">üîí Lock Day Permanently</button>
  </form>
</div>
{% endif %}

{% endif %}

<div style="margin-top:20px;text-align:right;">
  <button onclick="window.print()" class="btn btn-outline">üñ®Ô∏è Print</button>
</div>

{% endblock %}
