{% extends "base.html" %}
{% block title %}BDA Portal тАФ {{ bda_record.name if bda_record else 'BDA' }}{% endblock %}
{% block body_class %}has-action-bar{% endblock %}

{% block nav_tabs %}
<div class="tab-bar">
  <a href="/bda/portal" class="active">ЁЯПШя╕П BDA Portal</a>
  {% if request.session.user.role in ['OWNER','PARTNER','OFFICE','DELIVERY'] %}
  <a href="/bda/dashboard">ЁЯУЛ Manage BDA</a>
  {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="page-title">ЁЯПШя╕П BDA Portal</div>
<div class="page-sub">
  {% if bda_record %}
  {{ bda_record.name }} тАФ {{ bda_record.village }} ┬╖ {{ today.strftime('%d %B %Y') }}
  {% else %}
  {{ today.strftime('%d %B %Y') }}
  {% endif %}
</div>

<!-- BDA STOCK STATUS -->
{% if bda_stock %}
<div class="stat-grid">
  <div class="stat-box green">
    <div class="val">{{ bda_stock.get('5350', {}).get('filled', 0) }}</div>
    <div class="lbl">14.2kg рднрд░рд▓реЗрд▓реЗ / Filled</div>
  </div>
  <div class="stat-box amber">
    <div class="val">{{ bda_stock.get('5350', {}).get('empty', 0) }}</div>
    <div class="lbl">14.2kg рд░рд┐рдХрд╛рдореЗ / Empty</div>
  </div>
  {% if txns %}
  <div class="stat-box">
    <div class="val">{{ txns|length }}</div>
    <div class="lbl">Today's Transactions</div>
  </div>
  {% endif %}
</div>
{% endif %}

<!-- PENDING DELIVERIES FOR THIS BDA AREA -->
<div class="card">
  <div class="card-title">ЁЯУЛ рдЖрдЬрдЪреЗ рдкреЗрдВрдбрд┐рдВрдЧ / Pending Deliveries in Your Area</div>
  {% if pending %}
  <p style="font-size:0.8rem;color:#6b7280;margin-bottom:10px;">
    Customer рдиреЗ cylinder рдШреЗрддрд▓реНрдпрд╛рд╡рд░ OTP capture рдХрд░рд╛ / Capture OTP when customer collects cylinder
  </p>
  {% for d in pending %}
  <div class="delivery-card scheduled" style="margin-bottom:12px;">
    <div class="name">{{ d.consumer_name }}</div>
    <div class="addr">Consumer: {{ d.consumer_no }}</div>
    {% if d.mobile %}
    <a href="tel:{{ d.mobile }}" class="mobile-link">ЁЯУЮ {{ d.mobile }}</a>
    {% endif %}
    <div style="font-size:0.75rem;color:#6b7280;margin:4px 0;">{{ d.booking_type }} ┬╖ {{ d.area }}</div>

    <!-- OTP CAPTURE FORM -->
    <details style="margin-top:8px;">
      <summary class="btn btn-sm btn-success" style="cursor:pointer;display:inline-flex;">
        тЬЕ OTP Capture / рдбрд┐рд▓рд┐рд╡реНрд╣рд░ рдХреЗрд▓реЗ
      </summary>
      <form method="post" action="/bda/capture-otp/{{ d.id }}" style="margin-top:8px;padding:10px;background:#f0fdf4;border-radius:8px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div class="form-group">
            <label>OTP (6 digits)</label>
            <input type="text" name="otp" required maxlength="6" inputmode="numeric" placeholder="123456">
          </div>
          <div class="form-group">
            <label>Payment / рдкреЗрдореЗрдВрдЯ</label>
            <select name="payment_mode">
              <option value="CASH">ЁЯТ╡ Cash / рд░реЛрдЦ</option>
              <option value="QR_CODE">ЁЯУ▒ QR Code</option>
              <option value="GPAY">ЁЯУ▒ GPay</option>
              <option value="PAYTM">ЁЯУ▒ Paytm</option>
              <option value="PREPAID">тЬЕ Prepaid</option>
              <option value="MIXED">ЁЯТ▒ Mixed</option>
            </select>
          </div>
          <div class="form-group" style="grid-column:span 2;">
            <label>Amount тВ╣ (14.2kg = тВ╣856)</label>
            <input type="number" name="amount" value="856" min="0" inputmode="numeric">
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-block">тЬЕ OTP Submit рдХрд░рд╛</button>
      </form>
    </details>
  </div>
  {% endfor %}
  {% else %}
  <div style="text-align:center;color:#6b7280;padding:20px;">
    <div style="font-size:2rem;">тЬЕ</div>
    <p style="margin-top:6px;">рдпрд╛ рдПрд░рд┐рдпрд╛рдд рдкреЗрдВрдбрд┐рдВрдЧ рдирд╛рд╣реА / No pending deliveries in your area.</p>
  </div>
  {% endif %}
</div>

<!-- SPOT / URGENT DELIVERY -->
<div class="card">
  <div class="card-title">тЪб Spot Delivery / рддрд╛рддрдбреАрдЪреА рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА</div>
  <p style="font-size:0.8rem;color:#6b7280;margin-bottom:12px;">
    Customer рдиреЗ BPCL booking рдХреЗрд▓реА рдирд╛рд╣реА рдкрдг cylinder рд╣рд╡реЗ рдЖрд╣реЗ / Unbooked urgent cylinder sale
  </p>
  <form method="post" action="/bda/spot-delivery">
    {% if bda_record %}
    <input type="hidden" name="bda_id" value="{{ bda_record.id }}">
    {% else %}
    <div class="form-group">
      <label>BDA рдирд┐рд╡рдбрд╛</label>
      <select name="bda_id">
        {% for b in all_bdas %}
        <option value="{{ b.id }}">{{ b.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div class="form-group">
        <label>Customer Name / рдирд╛рд╡ *</label>
        <input type="text" name="consumer_name" required placeholder="Name">
      </div>
      <div class="form-group">
        <label>Consumer No (if known)</label>
        <input type="text" name="consumer_no" placeholder="Optional">
      </div>
      <div class="form-group">
        <label>Mobile / рдореЛрдмрд╛рдИрд▓</label>
        <input type="tel" name="mobile" placeholder="Optional" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>Payment / рдкреЗрдореЗрдВрдЯ</label>
        <select name="payment_mode">
          <option value="CASH">ЁЯТ╡ Cash</option>
          <option value="QR_CODE">ЁЯУ▒ QR Code</option>
          <option value="GPAY">ЁЯУ▒ GPay</option>
          <option value="PAYTM">ЁЯУ▒ Paytm</option>
          <option value="MIXED">ЁЯТ▒ Mixed</option>
        </select>
      </div>
      <div class="form-group">
        <label>Cash тВ╣</label>
        <input type="number" name="cash_amount" value="0" min="0" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>Online тВ╣ (GPay/QR)</label>
        <input type="number" name="online_amount" value="0" min="0" inputmode="numeric">
      </div>
    </div>
    <div class="form-group">
      <label>Notes / рдЯреАрдк</label>
      <input type="text" name="notes" placeholder="Any special note">
    </div>
    <button type="submit" class="btn btn-warning btn-block">тЪб Spot Delivery Record рдХрд░рд╛</button>
  </form>
</div>

<!-- TODAY'S COMPLETED AT THIS BDA -->
{% if txns %}
<div class="card">
  <div class="card-title">тЬЕ рдЖрдЬрдЪреЗ рдкреВрд░реНрдг рд╡реНрдпрд╡рд╣рд╛рд░ / Today's Completed</div>
  <div class="table-wrap">
    <table>
      <tr><th>Filled</th><th>Empty</th><th>Cash тВ╣</th><th>Online тВ╣</th><th>Notes</th></tr>
      {% for t in txns %}
      <tr>
        <td style="color:#057a55;">{{ t.filled_issued }}</td>
        <td style="color:#c27803;">{{ t.empty_received }}</td>
        <td>тВ╣{{ t.cash_paid|int }}</td>
        <td>тВ╣{{ t.online_paid|int }}</td>
        <td style="font-size:0.78rem;">{{ t.notes or 'тАФ' }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
{% endif %}

{% endblock %}
