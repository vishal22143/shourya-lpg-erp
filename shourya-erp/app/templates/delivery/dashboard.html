{% extends "base.html" %}
{% block title %}рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА / Delivery{% endblock %}

{% block nav_tabs %}
<div class="tab-bar">
  <a href="/godown/dashboard">ЁЯПн рдЧреЛрдбрд╛рдКрди</a>
  <a href="/delivery/dashboard" class="active">ЁЯЪЪ рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА / Delivery</a>
  <a href="/delivery/upload-csv">ЁЯУВ CSV Upload</a>
  {% if request.session.user.role in ['OWNER','PARTNER'] %}<a href="/owner/dashboard">ЁЯСС Owner</a>{% endif %}
</div>
{% endblock %}

{% block content %}
<div class="page-title">ЁЯЪЪ рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА рдбреЕрд╢рдмреЛрд░реНрдб / Delivery Dashboard</div>
<div class="page-sub">{{ today.strftime('%d %B %Y') }} ┬╖ {{ user.name }}</div>

{% if open_trip %}
<div class="alert alert-success">
  тЬЕ рд╕рдХреНрд░рд┐рдп рдЯреНрд░рд┐рдк / Active Trip #{{ open_trip.id }} тАФ {{ open_trip.vehicle.name }} ┬╖ {{ open_trip.total_sales }} delivered
  <a href="/delivery/trip/{{ open_trip.id }}" class="btn btn-sm btn-success" style="float:right;margin-top:-2px;">тЦ╢ Continue</a>
</div>
{% endif %}

<!-- OPEN NEW TRIP -->
{% if not open_trip %}
<div class="card">
  <div class="card-title">ЁЯЪж рдирд╡реАрди рдЯреНрд░рд┐рдк рд╕реБрд░реВ рдХрд░рд╛ / Start New Trip</div>
  <form method="post" action="/delivery/open-trip">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group">
        <label>рд╡рд╛рд╣рди / Vehicle<span class="mr">рдЖрдЬрдЪреЗ рд╡рд╛рд╣рди рдирд┐рд╡рдбрд╛</span></label>
        <select name="vehicle_id" required>
          {% for v in vehicles %}
          <option value="{{ v.id }}">{{ v.name }} ({{ v.capacity }} cyl)</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>рднрд░рд▓реЗрд▓реЗ рд╕рд┐рд▓реЗрдВрдбрд░ / Filled Cylinders<span class="mr">рдЧреЛрдбрд╛рдКрдирдордзреВрди рдХрд┐рддреА рдШреЗрддрд▓реЗ</span></label>
        <input type="number" name="filled_issued" min="1" max="65" required placeholder="e.g. 55">
      </div>
    </div>
    <button type="submit" class="btn btn-primary btn-block">ЁЯЪА рдЯреНрд░рд┐рдк рд╕реБрд░реВ / Start Trip</button>
  </form>
</div>
{% endif %}

<!-- TODAY'S TRIPS -->
{% if trips %}
<div class="card">
  <div class="card-title">ЁЯУЛ рдЖрдЬрдЪреНрдпрд╛ рдЯреНрд░рд┐рдкреНрд╕ / Today's Trips</div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Trip</th>
          <th>Delivery Man</th>
          <th>Vehicle</th>
          <th>Issued</th>
          <th>Sold</th>
          <th>Cash тВ╣</th>
          <th>Online тВ╣</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for t in trips %}
        <tr>
          <td>#{{ t.id }}</td>
          <td>{{ t.delivery_man.name }}</td>
          <td>{{ t.vehicle.name }}</td>
          <td>{{ t.filled_issued }}</td>
          <td><strong>{{ t.total_sales }}</strong></td>
          <td style="color:#057a55;">тВ╣{{ t.cash_collected|int }}</td>
          <td style="color:#1a56db;">тВ╣{{ t.online_collected|int }}</td>
          <td>
            {% if t.status.value == 'OPEN' %}
            <span class="badge badge-green">OPEN</span>
            {% else %}
            <span class="badge badge-gray">CLOSED</span>
            {% endif %}
          </td>
          <td>
            {% if t.status.value == 'OPEN' %}
            <a href="/delivery/trip/{{ t.id }}" class="btn btn-sm btn-primary">тЦ╢</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="card" style="text-align:center;color:#6b7280;padding:30px;">
  <div style="font-size:2.5rem;">ЁЯЪЪ</div>
  <p style="margin-top:8px;">рдЖрдЬ рдХреЛрдгрддреАрд╣реА рдЯреНрд░рд┐рдк рдирд╛рд╣реА / No trips today yet.</p>
</div>
{% endif %}

{% endblock %}
