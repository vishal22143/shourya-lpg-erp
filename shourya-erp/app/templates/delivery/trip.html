{% extends "base.html" %}
{% block title %}Trip #{{ trip.id }}{% endblock %}
{% block body_class %}has-action-bar{% endblock %}

{% block nav_tabs %}
<div class="tab-bar">
  <a href="/delivery/dashboard">тЖР Back</a>
  <a href="/delivery/trip/{{ trip.id }}" class="active">ЁЯЪЪ Trip #{{ trip.id }}</a>
  <a href="/bda/dashboard">ЁЯПШя╕П BDA</a>
</div>
{% endblock %}

{% block content %}
<div class="page-title">ЁЯЪЪ Trip #{{ trip.id }} тАФ {{ trip.vehicle.name }}</div>
<div class="page-sub">{{ trip.delivery_man.name }} ┬╖ {{ today.strftime('%d %B %Y') }}</div>

<!-- TRIP STATS -->
<div class="stat-grid">
  <div class="stat-box green">
    <div class="val">{{ trip.total_sales }}</div>
    <div class="lbl">Delivered / рдХреЗрд▓реЗ</div>
  </div>
  <div class="stat-box">
    <div class="val">{{ trip.filled_issued - trip.total_sales }}</div>
    <div class="lbl">Remaining / рдмрд╛рдХреА</div>
  </div>
  <div class="stat-box green">
    <div class="val">тВ╣{{ trip.cash_collected|int }}</div>
    <div class="lbl">Cash / рд░реЛрдЦ</div>
  </div>
  <div class="stat-box blue">
    <div class="val">тВ╣{{ trip.online_collected|int }}</div>
    <div class="lbl">Online / рдСрдирд▓рд╛рдИрди</div>
  </div>
</div>

<!-- AREA FILTER -->
{% if areas %}
<div style="overflow-x:auto;white-space:nowrap;margin-bottom:12px;padding:4px 0;">
  <a href="/delivery/trip/{{ trip.id }}" class="btn btn-sm {% if not selected_area %}btn-primary{% else %}btn-outline{% endif %}">All / рд╕рд░реНрд╡</a>
  {% for a in areas %}
  <a href="/delivery/trip/{{ trip.id }}?area={{ a }}" class="btn btn-sm {% if selected_area == a %}btn-primary{% else %}btn-outline{% endif %}" style="margin-left:6px;">{{ a }}</a>
  {% endfor %}
</div>
{% endif %}

<!-- DELIVERY LIST (MOBILE CARDS) -->
{% if deliveries %}
  {% for d in deliveries %}
  <div class="delivery-card scheduled" id="d_{{ d.id }}">
    <div class="name">{{ d.consumer_name }}</div>
    <div class="addr">ЁЯУН {{ d.address }}</div>
    {% if d.mobile %}
    <a href="tel:{{ d.mobile }}" class="mobile-link">ЁЯУЮ {{ d.mobile }}</a>
    {% endif %}
    <div style="font-size:0.75rem;color:#6b7280;margin:4px 0;">Consumer: {{ d.consumer_no }} ┬╖ {{ d.booking_type }}</div>

    <!-- DELIVER FORM -->
    <details style="margin-top:10px;">
      <summary class="btn btn-sm btn-success" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px;">
        тЬЕ Deliver / рдбрд┐рд▓рд┐рд╡реНрд╣рд░
      </summary>
      <form method="post" action="/delivery/deliver/{{ d.id }}" style="margin-top:10px;padding:12px;background:#f9fafb;border-radius:8px;">
        <input type="hidden" name="trip_id" value="{{ trip.id }}">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="form-group">
            <label>OTP (if available)</label>
            <input type="text" name="otp" placeholder="e.g. 123456" inputmode="numeric" maxlength="6">
          </div>
          <div class="form-group">
            <label>Payment / рдкреЗрдореЗрдВрдЯ</label>
            <select name="payment_mode">
              <option value="CASH">ЁЯТ╡ Cash / рд░реЛрдЦ</option>
              <option value="QR_CODE">ЁЯУ▒ QR Code Scan</option>
              <option value="GPAY">ЁЯУ▒ GPay</option>
              <option value="PAYTM">ЁЯУ▒ Paytm</option>
              <option value="PREPAID">тЬЕ Prepaid (BPCL Advance)</option>
              <option value="MIXED">ЁЯТ▒ Cash + Online (Mixed)</option>
              <option value="ONLINE">ЁЯМР Other Online</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount / рд░рдХреНрдХрдо тВ╣</label>
            <input type="number" name="amount" value="856" min="0" step="1" inputmode="numeric">
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" name="emergency" value="true" style="width:auto;"> No OTP / Emergency
            </label>
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-block">тЬЕ Mark Delivered / рдбрд┐рд▓рд┐рд╡реНрд╣рд░ рдХреЗрд▓реЗ</button>
      </form>
    </details>

    <!-- NOT DELIVERED -->
    <form method="post" action="/delivery/deliver/{{ d.id }}" style="display:inline;margin-left:8px;">
      <input type="hidden" name="trip_id" value="{{ trip.id }}">
      <input type="hidden" name="amount" value="0">
      <input type="hidden" name="payment_mode" value="CASH">
    </form>
  </div>
  {% endfor %}
{% else %}
<div class="card" style="text-align:center;color:#6b7280;padding:30px;">
  <div style="font-size:2.5rem;">ЁЯОЙ</div>
  <p style="margin-top:8px;">
    {% if selected_area %}рдпрд╛ рдПрд░рд┐рдпрд╛рдд рдХреЛрдгрддрд╛рд╣реА рдкреЗрдВрдбрд┐рдВрдЧ рдирд╛рд╣реА / No pending in this area.{% else %}рд╕рд░реНрд╡ рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА рдЭрд╛рд▓реНрдпрд╛ / All delivered!{% endif %}
  </p>
</div>
{% endif %}

{% endblock %}

<!-- CLOSE TRIP ACTION BAR -->
{% if trip.status.value == 'OPEN' %}
{% block scripts %}
<div class="action-bar">
  <button onclick="document.getElementById('closeTripModal').style.display='flex'" class="btn btn-danger">
    ЁЯПБ рдЯреНрд░рд┐рдк рдмрдВрдж / Close Trip
  </button>
  <a href="/bda/dashboard" class="btn btn-outline">ЁЯПШя╕П BDA</a>
</div>

<!-- CLOSE TRIP MODAL -->
<div id="closeTripModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:flex-end;">
  <div style="background:white;border-radius:16px 16px 0 0;padding:24px;width:100%;max-height:90vh;overflow-y:auto;">
    <h3 style="margin-bottom:16px;">ЁЯПБ рдЯреНрд░рд┐рдк рдмрдВрдж рдХрд░рд╛ / Close Trip #{{ trip.id }}</h3>
    <form method="post" action="/delivery/close-trip/{{ trip.id }}">
      <div class="form-group">
        <label>рд░рд┐рдХрд╛рдореЗ рд╕рд┐рд▓реЗрдВрдбрд░ рдкрд░рдд / Empty Returned to Godown<span class="mr">рдХрд┐рддреА рд░рд┐рдХрд╛рдореЗ рдЧреЛрдбрд╛рдКрдирдордзреНрдпреЗ рдкрд░рдд рдХреЗрд▓реЗ</span></label>
        <input type="number" name="empty_returned" min="0" value="{{ trip.total_sales }}" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>рдПрдХреВрдг рд░реЛрдЦ / Total Cash Collected тВ╣</label>
        <input type="number" name="cash_collected" value="{{ trip.cash_collected|int }}" min="0" inputmode="numeric">
      </div>
      <div class="form-group">
        <label>рдПрдХреВрдг рдСрдирд▓рд╛рдИрди / Total Online Collected тВ╣</label>
        <input type="number" name="online_collected" value="{{ trip.online_collected|int }}" min="0" inputmode="numeric">
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button type="button" onclick="document.getElementById('closeTripModal').style.display='none'" class="btn btn-outline" style="flex:1;">Cancel</button>
        <button type="submit" class="btn btn-danger" style="flex:2;">ЁЯПБ Confirm Close / рдмрдВрдж рдХрд░рд╛</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% endif %}
